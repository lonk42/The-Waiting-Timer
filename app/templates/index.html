<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Timer App</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center">
  <div class="max-w-3xl w-full text-center p-8">
    <!-- Total Time -->
    <h1 class="text-5xl font-bold text-indigo-400 mb-10">
      <div>Total time waited for {{ timer_name }}</div>
      <div id="total" class="mt-4 text-7xl text-white">{{ format_duration(total_seconds) }}</div>
    </h1>

    <!-- Controls -->
    <div class="flex justify-center gap-6 mb-10">
      <button onclick="startTimer()" class="px-6 py-3 rounded-lg bg-green-600 hover:bg-green-700 font-semibold">Start</button>
      <button onclick="stopTimer()" class="px-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 font-semibold">Stop</button>
    </div>

    <!-- Running Timer -->
    <div id="running" class="mb-12 hidden">
      <p class="text-xl text-red-400 font-semibold mb-2">Waiting...</p>
      <p id="subtimer" class="text-4xl font-mono text-red-300"></p>
    </div>

    <!-- Saved Timers -->
    <h2 class="text-2xl font-semibold text-gray-200 mb-6">Saved Timers</h2>
    <div id="timers" class="space-y-4">
      {% for t in timers %}
      <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg shadow-md text-left">
        <p><strong>{{ t.datetime }}</strong> — {{ format_duration(t.duration) }}</p>
        <input class="description-input w-full border border-gray-600 bg-gray-700 text-gray-100 rounded px-3 py-2 mt-3"
               type="text"
               placeholder="Add description..."
               value="{{ t.description }}"
               onblur="updateDescription({{ t.id }}, this.value)">
      </div>
      {% endfor %}
    </div>
  </div>

  <script>
    let subtimerInterval = null;
    let runningSince = null;

    async function startTimer() {
      await fetch("/start", {method: "POST"});
      fetchState();
    }

    async function stopTimer() {
      await fetch("/stop", {method: "POST"});
      fetchState();
    }

    async function updateDescription(id, description) {
      await fetch("/update_description", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({id, description})
      });
      fetchState();
    }

    function startSubtimer(startTime) {
      const runningDiv = document.getElementById("running");
      const subtimer = document.getElementById("subtimer");
      runningDiv.classList.remove("hidden");
      runningSince = startTime * 1000; // convert to ms

      if (subtimerInterval) clearInterval(subtimerInterval);
      subtimerInterval = setInterval(() => {
        const elapsed = Date.now() - runningSince;
        const mins = String(Math.floor(elapsed / 60000)).padStart(2, "0");
        const secs = String(Math.floor((elapsed % 60000) / 1000)).padStart(2, "0");
        const ms = String(Math.floor((elapsed % 1000) / 10)).padStart(2, "0");
        subtimer.textContent = `${mins}:${secs}.${ms}`;
      }, 50);
    }

    function stopSubtimer() {
      const runningDiv = document.getElementById("running");
      runningDiv.classList.add("hidden");
      if (subtimerInterval) clearInterval(subtimerInterval);
      subtimerInterval = null;
      runningSince = null;
    }

    async function fetchState() {
      const res = await fetch("/state");
      const data = await res.json();

      // update total
      document.getElementById("total").textContent =
        new Date(data.total * 1000).toISOString().substr(11, 8);

      // update running timer
      if (data.running) {
        startSubtimer(data.running.start_time);
      } else {
        stopSubtimer();
      }

      // rebuild timers list
      const timersDiv = document.getElementById("timers");
      timersDiv.innerHTML = "";
      data.timers.forEach(t => {
        const box = document.createElement("div");
        box.className = "p-4 bg-gray-800 border border-gray-700 rounded-lg shadow-md text-left";
        box.innerHTML = `
          <p><strong>${t.datetime}</strong> — ${formatDuration(t.duration)}</p>
          <input class="description-input w-full border border-gray-600 bg-gray-700 text-gray-100 rounded px-3 py-2 mt-3"
                 type="text"
                 placeholder="Add description..."
                 value="${t.description}"
                 onblur="updateDescription(${t.id}, this.value)">
        `;
        timersDiv.appendChild(box);
      });
    }

    function formatDuration(seconds) {
      const hrs = String(Math.floor(seconds / 3600)).padStart(2,"0");
      const mins = String(Math.floor((seconds % 3600) / 60)).padStart(2,"0");
      const secs = String(seconds % 60).padStart(2,"0");
      return `${hrs}:${mins}:${secs}`;
    }

    // refresh periodically
    setInterval(fetchState, 2000);
    fetchState();
  </script>
</body>
</html>

